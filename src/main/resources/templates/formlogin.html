<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
</head>
<body>
        <div th:replace="~{header.html}"></div>
    <h2>Login</h2>
    <form id = "formlogin" action="/formlogin" method="post">
        <label for="username">Username:</label>
        <input type="text" id="username" name="userid" required><br>
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required><br>
        <button type="submit">Login</button>
    </form>
</body>
	 <script type="module">
	import {loginAlarm} from "./js/alarmModule.js";
	 document.getElementById("formlogin").addEventListener("submit", async (e) => {
		    e.preventDefault(); // 기본 제출 방지

		    const userid = document.getElementById("username").value;
		    const password = document.getElementById("password").value;

		    try {
		        // 🔹 1. 로그인 요청
		        const response = await fetch('/validateMember', {
		            method: 'POST',
		            headers: { 'Content-Type': 'application/json' },
		            body: JSON.stringify({ "userid": userid, "password": password })
		        });

		        // 🔹 2. 응답 확인
		        if (!response.ok) {
		            alert("로그인에 실패하였습니다");
		            return;
		        }

		        const responseData = Number(await response.json()); // JSON 변환

		        alert("로그인에 성공하였습니다");

		        
		        
		        loginAlarm(responseData);
// 		        // 🔹 3. 로그인 성공 알람 요청
// 		        await fetch(`/alarm/loginSuccess/${responseData}`, {
// 		            method: "POST",
// 		            headers: { 'Content-Type': 'application/json' },
// // 		            credentials: "include", // ✅ 세션 유지 필수
// 		            body: JSON.stringify({ type: "LOGIN" })
// 		        });

		        // 🔹 4. 폼 제출
		        e.target.submit(); 

		    } catch (error) {
		        alert("로그인 요청 중 오류가 발생했습니다.");
		    }
		});

    </script>
</html>
